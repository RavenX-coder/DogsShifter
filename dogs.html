<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>DogsShifter</title>
    <script>
      window.tailwind = { config: { darkMode: "class" } };
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  </head>
  <body class="min-h-screen">
    <div id="root"></div>

    <script type="text/babel">
      const { useEffect, useMemo, useState } = React;

      const DEMO_USERS = {
        admin: { password: "admin123", role: "admin", displayName: "Administrator" },
        "員工A": { password: "passA123", role: "employee", displayName: "員工A" },
        "員工B": { password: "passB123", role: "employee", displayName: "員工B" },
      };
      const STORAGE_KEY = "dogs_shifter_shifts_v9";
      const RECENT_KEY = "dogs_shifter_recent_assigns_v1";

      // --------------------------
      // Helper functions (single definitions)
      // --------------------------
      function localDateYMD(d){ const year=d.getFullYear(); const month=d.getMonth(); const date=d.getDate(); return new Date(year,month,date,12,0,0,0); }
      function weekDatesFrom(startDate){ const base = localDateYMD(new Date(startDate)); const arr=[]; for(let i=0;i<7;i++){ const dd=new Date(base); dd.setDate(base.getDate()+i); arr.push(localDateYMD(dd)); } return arr; }
      function mondayOf(d){ const dt = localDateYMD(new Date(d)); const day = dt.getDay(); const diff=(day+6)%7; const m=new Date(dt); m.setDate(dt.getDate()-diff); m.setHours(12,0,0,0); return localDateYMD(m); }
      function formatDayLong(d){ const days=["星期日","星期一","星期二","星期三","星期四","星期五","星期六"]; return days[d.getDay()]; }
      function timeUntil(dt){ if(!dt) return ''; const now=new Date(); let diff=Math.floor((dt.getTime()-now.getTime())/1000); if(diff<0) diff=0; const days=Math.floor(diff/(3600*24)); diff-=days*3600*24; const hrs=Math.floor(diff/3600); diff-=hrs*3600; const mins=Math.floor(diff/60); if(days>0) return `${days} 天 ${hrs} 小時後`; if(hrs>0) return `${hrs} 小時 ${mins} 分鐘後`; if(mins>0) return `${mins} 分鐘後`; return '即將開始'; }
      function formatWeekRange(start){ const d1 = localDateYMD(new Date(start)); const d2 = new Date(d1); d2.setDate(d1.getDate()+6); const sd=['Sun','Mon','Tue','Wed','Thu','Fri','Sat']; return `${d1.getDate()}/${d1.getMonth()+1}(${sd[d1.getDay()]}) → ${d2.getDate()}/${d2.getMonth()+1}(${sd[d2.getDay()]})`; }

      function ExtraWeekDisplay({weekStart, username, shifts}){
        const dates = weekDatesFrom(weekStart).map(d=>d.toISOString().slice(0,10));
        const map = {}; dates.forEach(ds=>map[ds]=[]);
        shifts.forEach(s=>{ if(!s.Date) return; if(s.AssignedTo !== username) return; const k = localDateYMD(new Date(s.Date+'T00:00:00')).toISOString().slice(0,10); if(map[k]) map[k].push(s); });
        return (
          <div className="grid grid-cols-7 gap-2 overflow-x-auto">
            {dates.map(ds=> (
              <div key={ds} className="p-2 border rounded text-center">
                <div className="font-medium">{ds}</div>
                {map[ds].length===0 ? <div className="text-xs text-gray-400">無班次</div> : map[ds].map((s,i)=>(<div key={i} className="mt-2"><div className="font-bold">{s.Name}</div><div>{s.On_time}</div><div className="text-xs">{s.On_Locat}</div></div>))}
              </div>
            ))}
          </div>
        );
      }

      function DogsShifter() {
        // auth + data
        const [user, setUser] = useState(null);
        const [theme, setTheme] = useState(localStorage.getItem("ds_theme") || "light");
        const [shifts, setShifts] = useState(() => { try { const raw = localStorage.getItem(STORAGE_KEY); return raw ? JSON.parse(raw) : []; } catch { return []; } });
        const [message, setMessage] = useState("");

        // ui
        const [nav, setNav] = useState("shift");
        const [sidebarOpen, setSidebarOpen] = useState(true);
        const [simulateMobile, setSimulateMobile] = useState(false);
        const [isMobile, setIsMobile] = useState(() => typeof window !== 'undefined' ? window.innerWidth <= 768 : false);

        // import modal and delete
        const [currentImport, setCurrentImport] = useState(null); // { group, batchId }
        const [deleteConfirm, setDeleteConfirm] = useState(null);

        // assign memory
        const [assignSelections, setAssignSelections] = useState({}); // ephemeral UI selections

        // assign context
        const usersList = Object.keys(DEMO_USERS);
        const employees = usersList;
        const [assignEmployee, setAssignEmployee] = useState(employees[0]||'admin');
        const [assignWeekStart, setAssignWeekStart] = useState(() => mondayOf(localDateYMD(new Date())));

        // recent assigns and templates
        const [recentAssigns, setRecentAssigns] = useState(() => { try { const raw = localStorage.getItem(RECENT_KEY); return raw ? JSON.parse(raw) : {}; } catch { return {}; } });

        useEffect(() => { localStorage.setItem("ds_theme", theme); document.documentElement.classList.toggle("dark", theme === "dark"); }, [theme]);
        useEffect(() => { try { localStorage.setItem(STORAGE_KEY, JSON.stringify(shifts)); } catch (e) { console.error(e); } }, [shifts]);
        useEffect(() => { try { localStorage.setItem(RECENT_KEY, JSON.stringify(recentAssigns)); } catch (e) {} }, [recentAssigns]);

        // responsive behavior
        useEffect(() => {
          function onResize(){ const mobile = window.innerWidth <= 768; setIsMobile(mobile); if(mobile) setSidebarOpen(false); else setSidebarOpen(true); }
          window.addEventListener('resize', onResize);
          onResize();
          return ()=>window.removeEventListener('resize', onResize);
        }, []);

        // login form
        const [username, setUsername] = useState("");
        const [password, setPassword] = useState("");
        function doLogin(){ const u = DEMO_USERS[username]; if(u && u.password===password){ setUser({ username, role:u.role, displayName:u.displayName||username }); setUsername(''); setPassword(''); setMessage(''); setNav('shift'); loadAssignMemoryForUserWeek(username, assignWeekStart); } else setMessage('登入失敗：用戶名或密碼不正確'); }
        function doLogout(){ setUser(null); }

        // groups and templates
        function getGroupKey(name){ if(!name) return 'UNKNOWN'; const m = name.match(/^([A-Za-z][0-9]{2})/); if(m) return m[1].toUpperCase(); return name.slice(0,3).toUpperCase(); }

        const templateMap = useMemo(()=>{
          const map = {};
          shifts.forEach(s=>{ if(!s._batchId) return; if(s.Date && s.Date.trim()) return; const g = s._group || getGroupKey(s.Name); const last3 = s.Name.slice(g.length); if(!/^[0-9]{3}$/.test(last3)) return; if(!map[g]) map[g]=new Set(); map[g].add(last3); });
          const out = {}; Object.keys(map).forEach(k=> out[k]=Array.from(map[k]).sort()); return out;
        }, [shifts]);
        const groupsList = Object.keys(templateMap).sort();

        // import handling (batchId per import)
        function handleFileInput(e){ const file = e.target.files && e.target.files[0]; if(!file) return; Papa.parse(file,{ header:true, skipEmptyLines:true, complete:(res)=>{ const importedAt = new Date().toISOString().slice(0,10); const batchId = Date.now().toString(); const rows = (res.data||[]).map((raw,i)=>{ const name = (raw.Name||raw.name||raw.shiftId||`S${Date.now()}${i}`).toString().trim(); const group = getGroupKey(name); return { Name:name, On_Locat:raw.On_Locat||'', On_time:raw.On_time||'', Off_time:raw.Off_time||'', Off_Locat:raw.Off_Locat||'', Hours:raw.Hours||'', Work:raw.Work||'', Break_Start:raw.Break_Start||'', Break_End:raw.Break_End||'', Date:raw.Date||'', AssignedTo:raw.AssignedTo||'', _importLine:i+2, _importedAt:importedAt, _batchId:batchId, _group:group }; }); setShifts(prev=>[...prev,...rows]); setMessage(`已匯入 ${rows.length} 筆`); }, error:(err)=> setMessage(`CSV 解析錯誤: ${err?.message||err}`) }); e.target.value=''; }

        // delete modal flow
        function openDeleteConfirm(batchId){ const group = shifts.find(s=>s._batchId===batchId)?._group; const count = shifts.filter(s=>s._batchId===batchId).length; setDeleteConfirm({ batchId, group, count }); }
        function cancelDelete(){ setDeleteConfirm(null); }
        function performDeleteConfirmed(){ if(!deleteConfirm) return; const { batchId } = deleteConfirm; setShifts(prev=> prev.filter(s=> s._batchId !== batchId)); setMessage(`已刪除批次 ${batchId}`); setDeleteConfirm(null); }

        // grouping summaries
        const importSummaries = useMemo(()=>{ const map={}; shifts.forEach(s=>{ if(!s._batchId) return; const k=s._batchId; if(!map[k]) map[k]={ batchId:k, group:s._group||getGroupKey(s.Name), importedAt:s._importedAt, count:0 }; map[k].count+=1; }); return Object.values(map).sort((a,b)=> (b.importedAt||'').localeCompare(a.importedAt||'')); }, [shifts]);

        // shift grouping by day for a username and weekStart
        function shiftsForFilter(username, start){ const startM = localDateYMD(new Date(start||mondayOf(new Date()))); const endM = new Date(startM.getTime()+7*24*3600*1000); return shifts.filter(s=>{ if(s.AssignedTo && s.AssignedTo !== username) return false; if(s.Date && s.Date.length>=4){ const d = localDateYMD(new Date(s.Date+'T00:00:00')); return d>=startM && d<endM; } return false; }); }
        function groupShiftsByDay(username, start){ const arr = shiftsForFilter(username,start); const dates = weekDatesFrom(start||mondayOf(new Date())).map(d=>d.toISOString().slice(0,10)); const map={}; dates.forEach(ds=>map[ds]=[]); arr.forEach(s=>{ const k = localDateYMD(new Date(s.Date+'T00:00:00')).toISOString().slice(0,10); if(!map[k]) map[k]=[]; map[k].push(s); }); return { map, dates }; }

        // next upcoming
        function parseDateTime(dateStr,timeStr){ if(!dateStr||!timeStr) return null; const t=timeStr.trim(); const parts=t.split(":"); if(parts.length<2) return null; const hh=parts[0].padStart(2,'0'); const mm=parts[1].padStart(2,'0'); const iso=`${dateStr}T${hh}:${mm}:00`; const d=new Date(iso); return isNaN(d)?null:d; }
        function nextUpcomingShift(username){ const now=new Date(); const candidates = shifts.filter(s=>s.AssignedTo===username && s.Date && s.On_time).filter(s=>{ const dt=parseDateTime(s.Date,s.On_time); return dt && dt.getTime()>now.getTime(); }).sort((a,b)=> parseDateTime(a.Date,a.On_time)-parseDateTime(b.Date,b.On_time)); return candidates.length?candidates[0]:null; }

        // Assign memory: persist per user-week
        function assignsKey(u, weekStart){ return `assigns::${u}::${localDateYMD(new Date(weekStart)).toISOString().slice(0,10)}`; }
        function saveAssignMemoryForUserWeek(u, weekStart, data){ try{ localStorage.setItem(assignsKey(u,weekStart), JSON.stringify(data)); setMessage('已儲存暫存指派'); }catch(e){ console.error(e);} }
        function loadAssignMemoryForUserWeek(u, weekStart){ try{ const raw = localStorage.getItem(assignsKey(u,weekStart)); if(!raw) return null; const parsed = JSON.parse(raw); setAssignSelections(parsed); return parsed; }catch(e){ console.error(e); return null; } }

        // when user or week changes, auto-load memory
        useEffect(()=>{ if(user) loadAssignMemoryForUserWeek(user.username, assignWeekStart); }, [user, assignWeekStart]);

        // when selections change, auto-save
        useEffect(()=>{ if(!user) return; saveAssignMemoryForUserWeek(user.username, assignWeekStart, assignSelections); }, [assignSelections]);

        // Assign actions (select group + last3 -> build Name, find template and assign/update)
        function setSelection(dateStr, part, val){ setAssignSelections(prev=> ({ ...prev, [dateStr]: { ...(prev[dateStr]||{}), [part]: val } })); }

        function confirmAssignments(){ const dates = weekDatesFrom(assignWeekStart).map(d=>d.toISOString().slice(0,10)); const toAdd=[]; const updated=[]; for(const ds of dates){ const sel = assignSelections[ds]; if(!sel || !sel.group || !sel.last3) continue; const name = `${sel.group}${sel.last3}`; const tmpl = shifts.find(s=>s.Name===name && s._batchId && (!s.Date||s.Date.trim()==='')); if(!tmpl){ setMessage(`${name} 未在匯入範本中找到，請先匯入`); return; } const existingIndex = shifts.findIndex(s=>s.Date===ds && s.AssignedTo===assignEmployee); const copy = { ...tmpl, Date:ds, AssignedTo:assignEmployee, _assignedFromTemplate:true }; delete copy._batchId; delete copy._importLine; delete copy._importedAt; if(existingIndex!==-1){ updated.push({ index: existingIndex, item: copy }); } else { toAdd.push(copy); } // update recent
          setRecentAssigns(prev=>{ const cur = prev[assignEmployee] ? [...prev[assignEmployee]] : []; const idx = cur.indexOf(name); if(idx!==-1) cur.splice(idx,1); cur.unshift(name); if(cur.length>20) cur.pop(); return { ...prev, [assignEmployee]: cur }; }); }
          setShifts(prev=>{ const copy=[...prev]; updated.forEach(u=>{ copy[u.index]=u.item; }); return [...copy, ...toAdd]; }); if(toAdd.length+updated.length===0) { setMessage('尚未選擇任何班次'); return; } setMessage(`已為 ${assignEmployee} 指派/更新 ${toAdd.length+updated.length} 筆`); setAssignSelections({}); }

        // UI grouping for current user-week
        const groupedResult = groupShiftsByDay(user?user.username:'', assignWeekStart);
        const groupedMap = groupedResult.map; const groupedDates = groupedResult.dates; const myNext = user ? nextUpcomingShift(user.username) : null;
        const todayKey = localDateYMD(new Date()).toISOString().slice(0,10);

        // extra view control under Shift: 'none' | 'nextWeek' | 'otherEmployee'
        const [extraView, setExtraView] = useState('none');
        const [extraEmployee, setExtraEmployee] = useState(employees[1]||employees[0]);

        // render helper small components
        function DogsLogo({size=56}){ return (<svg width={size} height={size} viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="g1" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stopColor="#0ea5a4"/><stop offset="100%" stopColor="#06b6d4"/></linearGradient></defs><rect rx="18" width="120" height="120" fill="url(#g1)"/><circle cx="40" cy="45" r="8" fill="#fff"/><circle cx="55" cy="32" r="7" fill="#fff"/><circle cx="70" cy="45" r="8" fill="#fff"/><ellipse cx="55" cy="62" rx="25" ry="18" fill="#fff"/></svg>); }

        // login screen
        if(!user) return (
          <div className="min-h-screen flex items-center justify-center bg-gray-50 dark:bg-gray-900 p-6">
            <div className="w-full max-w-md">
              <div className="bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-md text-center">
                <div className="mb-4 flex justify-center"><DogsLogo/></div>
                <h1 className="text-2xl font-bold mb-1">DogsShifter</h1>
                <p className="text-sm text-gray-500 mb-4">員工更表快速檢視</p>
                <div className="space-y-3">
                  <input className="w-full p-3 rounded-lg border" placeholder="帳號 (例如：員工A)" value={username} onChange={e=>setUsername(e.target.value)} />
                  <input className="w-full p-3 rounded-lg border" placeholder="密碼" type="password" value={password} onChange={e=>setPassword(e.target.value)} />
                  <button className="w-full p-3 rounded-lg bg-gradient-to-r from-indigo-600 to-cyan-500 text-white font-medium" onClick={doLogin}>登入</button>
                  {message && <div className="text-sm text-red-500">{message}</div>}
                  <div className="text-xs text-gray-400">示範帳戶：admin/admin123，員工A/passA123，員工B/passB123</div>
                </div>
              </div>
            </div>
          </div>
        );

        // main layout
        return (
          <div className={`min-h-screen flex ${theme==='dark'?'bg-gray-900 text-gray-100':'bg-gray-50 text-gray-900'}`}>
            {/* sidebar (collapsible) */}
            <aside className={`${sidebarOpen? 'w-64':'w-16'} p-3 border-r dark:border-gray-700 transition-all hidden md:block`}>
              <div className="flex items-center justify-between mb-4">
                <div className="flex items-center gap-3">
                  <div className="w-10 h-10 rounded bg-white dark:bg-gray-800 flex items-center justify-center"><DogsLogo size={36}/></div>
                  {sidebarOpen && <div><div className="font-semibold">DogsShifter</div><div className="text-xs text-gray-400">{user.displayName}</div></div>}
                </div>
                {sidebarOpen && <button className="px-2" onClick={()=>setSidebarOpen(false)}>‹</button>}
              </div>
              <nav className="space-y-2">
                <button className={`w-full text-left p-2 rounded ${nav==='shift'?'bg-indigo-600 text-white':''}`} onClick={()=>setNav('shift')}>Shift</button>
                {user.role==='admin' && <button className={`w-full text-left p-2 rounded ${nav==='import'?'bg-indigo-600 text-white':''}`} onClick={()=>setNav('import')}>Import</button>}
                {user.role==='admin' && <button className={`w-full text-left p-2 rounded ${nav==='assign'?'bg-indigo-600 text-white':''}`} onClick={()=>setNav('assign')}>Assign</button>}
                <button className={`w-full text-left p-2 rounded ${nav==='setting'?'bg-indigo-600 text-white':''}`} onClick={()=>setNav('setting')}>Setting</button>
              </nav>
              <div className="mt-6"><button className="w-full p-2 rounded bg-red-600 text-white" onClick={doLogout}>登出</button></div>
            </aside>

            {/* mobile topbar */}
            <div className="md:hidden w-full p-3 bg-white dark:bg-gray-800 flex items-center justify-between">
              <div className="flex items-center gap-3">
                <button onClick={()=>setSidebarOpen(s=>!s)} className="px-2 py-1 border rounded">☰</button>
                <div className="font-semibold">DogsShifter</div>
              </div>
              <div className="flex gap-2 items-center"><button className="px-2 py-1 rounded border" onClick={()=>setTheme(t=>t==='dark'?'light':'dark')}>{theme==='dark'?'淺色':'深色'}</button><button className="px-2 py-1 rounded bg-red-600 text-white" onClick={doLogout}>登出</button></div>
            </div>

            {/* main content */}
            <main className="flex-1 p-4">
              {/* SHIFT view */}
              {nav==='shift' && (
                <div>
                  <div className="flex items-center justify-between mb-3">
                    <div><div className="text-sm text-gray-400">本週排班 {formatWeekRange(assignWeekStart)}</div></div>
                    <div className="flex items-center gap-2">
                      <button className="px-2 py-1 rounded border" onClick={()=>{ setAssignWeekStart(mondayOf(new Date(assignWeekStart.getTime()-7*24*3600*1000))); }}>上一週</button>
                      <button className="px-2 py-1 rounded border" onClick={()=>{ setAssignWeekStart(mondayOf(new Date(assignWeekStart.getTime()+7*24*3600*1000))); }}>下一週</button>
                    </div>
                  </div>

                  {/* week grid */}
                  <div className="overflow-x-auto">
                    <div className="min-w-[900px] grid grid-cols-7 gap-3">
                      {groupedDates.map(ds=>{
                        const list = groupedMap[ds] || [];
                        const isToday = ds===todayKey;
                        return (
                          <div key={ds} className={`p-3 rounded-lg ${isToday? 'bg-yellow-50':''} shadow-sm text-center`}>
                            <div className="font-medium mb-2">{formatDayLong(new Date(ds))}<div className="text-xs text-gray-400">{ds}</div></div>
                            <div className="space-y-2">
                              {list.length===0? <div className="text-xs text-gray-400">無班次</div> : list.map((s,idx)=> (
                                <div key={idx} className="p-2 rounded border text-center">
                                  <div className="text-base font-bold">{s.Name}</div>
                                  <div className="text-xl font-semibold mt-1">{s.On_time || '-'}</div>
                                  <div className="text-sm">{s.On_Locat || '-'}</div>
                                  <div className="text-xs my-1 inline-block px-2 py-1 bg-green-600 text-white rounded">Break : {(s.Break_Start||'-') + (s.Break_End? ` – ${s.Break_End}` : '')}</div>
                                  <div className="text-xl font-semibold mt-2">{s.Off_time || '-'}</div>
                                  <div className="text-sm">{s.Off_Locat || '-'}</div>
                                  <div className="text-xs mt-1 inline-block px-2 py-1 bg-blue-600 text-white rounded">Hours : {s.Hours || '-'}</div>
                                  <div className="text-xs mt-1">{s.Work || '-'}</div>
                                </div>
                              ))}
                            </div>
                          </div>
                        ); })}
                    </div>
                  </div>

                  {/* extra view selector */}
                  <div className="mt-6 p-3 rounded bg-white shadow-sm">
                    <div className="flex items-center gap-3 mb-3">
                      <div className="text-sm font-medium">顯示其他排班：</div>
                      <select value={extraView} onChange={e=>setExtraView(e.target.value)} className="p-2 rounded border">
                        <option value="none">不顯示</option>
                        <option value="nextWeek">下週更表</option>
                        <option value="otherEmployee">其他員工的更表</option>
                      </select>
                      {extraView==='otherEmployee' && (
                        <select value={extraEmployee} onChange={e=>setExtraEmployee(e.target.value)} className="p-2 rounded border">
                          {employees.filter(u=>u!==user.username).map(u=> <option key={u} value={u}>{DEMO_USERS[u]?.displayName||u}</option>)}
                        </select>
                      )}
                    </div>

                    {extraView==='nextWeek' && (
                      <div>
                        <div className="text-sm text-gray-500 mb-2">下週排班 ({formatWeekRange(new Date(assignWeekStart.getTime()+7*24*3600*1000))})</div>
                        {/* reuse grouping, but for next week */}
                        <ExtraWeekDisplay weekStart={new Date(assignWeekStart.getTime()+7*24*3600*1000)} username={user.username} shifts={shifts} />
                      </div>
                    )}

                    {extraView==='otherEmployee' && (
                      <div>
                        <div className="text-sm text-gray-500 mb-2">{extraEmployee} 的排班 ({formatWeekRange(assignWeekStart)})</div>
                        <ExtraWeekDisplay weekStart={assignWeekStart} username={extraEmployee} shifts={shifts} />
                      </div>
                    )}
                  </div>

                  {/* next-up */}
                  <div className="mt-6">
                    <h3 className="text-sm text-gray-400 mb-2">次日更次</h3>
                    {myNext ? (
                      <div className="p-4 rounded-lg bg-white shadow-sm flex justify-between items-center">
                        <div>
                          <div className="text-xs text-gray-400">{myNext.Date}</div>
                          <div className="text-lg font-medium">{myNext.Name}</div>
                          <div className="text-sm">{myNext.On_time} - {myNext.Off_time}</div>
                          <div className="text-xs text-gray-400">{myNext.On_Locat} → {myNext.Off_Locat}</div>
                          <div className="text-xs text-gray-400">備註: {myNext.Work || '-'}</div>
                        </div>
                        <div className="text-right text-sm text-gray-500">{timeUntil(parseDateTime(myNext.Date,myNext.On_time))}</div>
                      </div>
                    ) : <div className="p-3 rounded bg-white/40 text-sm">目前沒有已知的未來班次。</div>}
                  </div>

                </div>
              )}

              {/* IMPORT view */}
              {nav==='import' && user.role==='admin' && (
                <div>
                  <h2 className="text-sm text-gray-400 mb-2">Import — 匯入總覽</h2>
                  <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                    {importSummaries.map((s,i)=> (
                      <div key={i} className="p-4 rounded bg-white shadow-sm">
                        <div className="font-medium">{s.group} （{s.count} 項）</div>
                        <div className="text-xs text-gray-400">批次ID: {s.batchId}</div>
                        <div className="mt-3 flex gap-2">
                          <button className="px-3 py-1 rounded bg-indigo-600 text-white" onClick={()=>{ setCurrentImport({group:s.group,batchId:s.batchId}); setNav('import-view'); }}>查閱內容</button>
                          <button className="px-3 py-1 rounded bg-red-600 text-white" onClick={()=>openDeleteConfirm(s.batchId)}>刪除</button>
                        </div>
                      </div>
                    ))}
                    <div className="p-4 rounded bg-white shadow-sm flex flex-col justify-between">
                      <div><div className="font-medium">匯入 CSV</div><div className="text-xs text-gray-400">上傳新的更表（追加）</div></div>
                      <div className="mt-3"><input type="file" accept=".csv" onChange={handleFileInput} /></div>
                    </div>
                  </div>
                </div>
              )}

              {/* IMPORT VIEW */}
              {nav==='import-view' && user.role==='admin' && currentImport && (
                <div>
                  <div className="flex items-center justify-between mb-3">
                    <div><div className="text-lg font-medium">批次 {currentImport.batchId}</div><div className="text-xs text-gray-400">群組: {currentImport.group}</div></div>
                    <div className="flex gap-2"><button className="px-3 py-1 rounded border" onClick={()=>{ setNav('import'); setCurrentImport(null); }}>返回</button><button className="px-3 py-1 rounded bg-red-600 text-white" onClick={()=>openDeleteConfirm(currentImport.batchId)}>刪除此批次</button></div>
                  </div>
                  <div className="grid grid-cols-1 gap-3">
                    {shifts.filter(s=>s._batchId===currentImport.batchId).map((s,idx)=> (
                      <div key={idx} className="p-3 rounded bg-white border">
                        <div className="font-medium">{s.Name} {s.Date?`(${s.Date})`:''}</div>
                        <div className="text-xs mt-1">上班: {s.On_time||'-'} / {s.On_Locat||'-'} • 休息: {(s.Break_Start||'-')+(s.Break_End?`~${s.Break_End}`:'')} • 下班: {s.Off_time||'-'} / {s.Off_Locat||'-'}</div>
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {/* ASSIGN view */}
              {nav==='assign' && user.role==='admin' && (
                <div>
                  <h2 className="text-sm text-gray-400 mb-2">Assign — 編更介面</h2>
                  <div className="p-4 rounded bg-white shadow損 mb-4">
                    <div className="grid grid-cols-1 sm:grid-cols-3 gap-3">
                      <div><div className="text-xs text-gray-500">選擇員工</div><select value={assignEmployee} onChange={e=>setAssignEmployee(e.target.value)} className="p-2 rounded border w-full">{employees.map(emp=> <option key={emp} value={emp}>{DEMO_USERS[emp]?.displayName||emp}</option>)}</select></div>
                      <div><div className="text-xs text-gray-500">選擇週開始（週一）</div><input type="date" value={localDateYMD(new Date(assignWeekStart)).toISOString().slice(0,10)} onChange={e=>{ const d=new Date(e.target.value); setAssignWeekStart(mondayOf(d)); }} className="p-2 rounded border w-full"/></div>
                      <div><div className="text-xs text-gray-500">說明</div><div className="text-xs text-gray-400 mt-2">選群組→選後3位。編輯會自動儲存（回到此頁會還原你上次的編輯），按確認會完成指派/更新。</div></div>
                    </div>

                    <div className="mt-4 flex flex-col gap-2">
                      {weekDatesFrom(assignWeekStart).map(d=>{ const ds=d.toISOString().slice(0,10); const sel=assignSelections[ds]||{}; const last3Options = sel.group ? (templateMap[sel.group]||[]) : []; const recentForUser = recentAssigns[assignEmployee]||[]; return (
                        <div key={ds} className="p-2 border rounded flex items-center justify-between">
                          <div><div className="font-medium">{formatDayLong(d)} ({ds})</div><div className="text-xs text-gray-400">先選群組，再選後3位（若有自動儲存，下次回到此頁會還原）</div></div>
                          <div className="flex items-center gap-2">
                            <select className="p-2 rounded border" value={sel.group||''} onChange={e=>setSelection(ds,'group',e.target.value)}><option value="">-- 群組 --</option>{groupsList.map(g=> <option key={g} value={g}>{g}</option>)}</select>
                            <select className="p-2 rounded border" value={sel.last3||''} onChange={e=>setSelection(ds,'last3',e.target.value)}><option value="">-- 後3位 --</option>{last3Options.map(l=> <option key={l} value={l}>{l}</option>)}{recentForUser.map(rn=>{ if(!sel.group) return null; if(rn.startsWith(sel.group)) return <option key={rn} value={rn.slice(sel.group.length)}>{rn.slice(sel.group.length)}</option>; return null; })}</select>
                          </div>
                        </div>
                      ); })}
                    </div>

                    <div className="mt-4 flex gap-2"><button className="px-4 py-2 rounded bg-indigo-600 text-white" onClick={confirmAssignments}>確認指派</button><button className="px-4 py-2 rounded border" onClick={()=>{ setAssignSelections({}); setMessage('已重設'); }}>重設</button></div>
                  </div>
                </div>
              )}

              {/* SETTING */}
              {nav==='setting' && (
                <div>
                  <h2 className="text-sm text-gray-400 mb-2">Setting</h2>
                  <div className="p-4 rounded bg-white shadow-sm">
                    <div className="mb-3"><div className="text-xs text-gray-500">主題</div><div className="mt-2 flex gap-2"><button className={`px-3 py-2 rounded ${theme==='light'?'bg-indigo-600 text-white':''}`} onClick={()=>setTheme('light')}>Light</button><button className={`px-3 py-2 rounded ${theme==='dark'?'bg-indigo-600 text-white':''}`} onClick={()=>setTheme('dark')}>Dark</button></div></div>
                    <div className="mb-3"><div className="text-xs text-gray-500">模擬手機 (在桌機上預覽 mobile)</div><div className="mt-2"><label className="inline-flex items-center"><input type="checkbox" checked={simulateMobile} onChange={e=>setSimulateMobile(e.target.checked)} className="mr-2"/> 開啟模擬手機視圖</label></div></div>

                    <div className="mb-3"><div className="text-xs text-gray-500">如何在真手機測試 (開發用)</div>
                      <div className="text-xs text-gray-400 mt-2">啟動你的 dev server（例如 npm start / yarn dev），確保你的電腦與手機在同一 Wi‑Fi。找到你的電腦局域網 IP（例如 192.168.0.12）並把 dev server 端口加上（例如 5173），在手機瀏覽器打開: <strong>http://192.168.0.12:5173</strong>。在 Setting 的 Debug Panel 可複製 localStorage JSON 供問題回報。</div>
                    </div>

                    <div className="mt-4 p-3 bg-gray-50 rounded"><div className="text-xs font-medium">Debug (LocalStorage dump)</div><pre style={{whiteSpace:'pre-wrap',fontSize:11}}>{JSON.stringify({shifts,recentAssigns},null,2)}</pre></div>
                  </div>
                </div>
              )}

            </main>

            {/* delete confirm modal */}
            {deleteConfirm && (
              <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/30 p-4">
                <div className="bg-white rounded-lg p-4 w-full max-w-md">
                  <div className="font-semibold mb-2">刪除確認</div>
                  <div className="text-sm text-gray-600 mb-2">批次: {deleteConfirm.batchId} • 群組: {deleteConfirm.group} • 筆數: {deleteConfirm.count}</div>
                  <div className="flex justify-end gap-2 mt-4"><button className="px-3 py-1 rounded border" onClick={cancelDelete}>取消</button><button className="px-3 py-1 rounded bg-red-600 text-white" onClick={performDeleteConfirmed}>刪除</button></div>
                </div>
              </div>
            )}

            {message && <div className="fixed left-4 bottom-4 bg-yellow-100 text-sm p-2 rounded shadow">{message}</div>}
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<DogsShifter />);
    </script>
  </body>
</html>